version: "3.7"

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      SITE_NAME: "site.local"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_USER: "frappe"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      GPT_APP_GIT: "${GPT_APP_GIT}"
    command: >
      bash -c "
        echo '‚è≥ Warte auf MariaDB...';
        sleep 5;
        echo 'üöÄ Starte: bench new-site';
        bench new-site --no-mariadb-socket --admin-password ${ADMIN_PASSWORD} ${SITE_NAME} &&
        echo '‚úÖ Site erstellt';
        sleep 300"
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio
    volumes:
      - sites:/home/frappe/frappe-bench/sites

  mariadb:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: frappe
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb:/var/lib/mysql

  redis-cache:
    image: redis:7-alpine
  redis-queue:
    image: redis:7-alpine
  redis-socketio:
    image: redis:7-alpine

volumes:
  mariadb:
  sites:

