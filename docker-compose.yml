version: "3.7"

services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      SITE_NAME: "site.local"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_USER: "frappe"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      # üëâ DEINE echte Repository‚ÄëURL (public oder mit PAT)
      GPT_APP_GIT: "${GPT_APP_GIT}"
command: >
  bash -c "
    echo '‚è≥ Warte auf MariaDB...';
    sleep 5;

    if [ ! -d sites/${SITE_NAME} ]; then
      echo 'üöÄ Starte Initialisierung';
      bench new-site --no-mariadb-socket --admin-password ${ADMIN_PASSWORD} ${SITE_NAME} &&
      echo '‚úÖ Site erstellt' &&
      bench get-app --branch version-15 erpnext &&
      echo '‚úÖ ERPNext geladen' &&
      bench --site ${SITE_NAME} install-app erpnext &&
      echo '‚úÖ ERPNext installiert' &&
      bench get-app ${GPT_APP_GIT} &&
      echo '‚úÖ GPT App geladen' &&
      bench --site ${SITE_NAME} install-app gpt_assistant &&
      echo '‚úÖ GPT installiert' &&
      bench set-config -g openai_api_key ${OPENAI_API_KEY} &&
      echo '‚úÖ Key gesetzt';
    fi;

    echo '‚ñ∂ Starte Bench';
    bench start"
    
    depends_on:
      - mariadb
      - redis-cache
      - redis-queue
      - redis-socketio
    volumes:
      - sites:/home/frappe/frappe-bench/sites

  mariadb:
    image: mariadb:10.6
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: frappe
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb:/var/lib/mysql

  redis-cache:
    image: redis:7-alpine
  redis-queue:
    image: redis:7-alpine
  redis-socketio:
    image: redis:7-alpine

volumes:
  mariadb:
  sites:
